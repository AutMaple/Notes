# RabbitMQ

## 什么是消息队列

消息指的是两个应用之间传递的数据。数据的格式是多样的，可以是文本字符串，也可以包含嵌入对象。

消息队列(Message Queue) 是在消息传递的过程中用于保存消息的容器。在消息传递的过程中，发送消息的叫做生产者，接收消息的叫做消费者。生产者往消息队列中写入数据，消费者从消息队列中读取数据。生产者只管往消息队列中写入数据，而不用管消息如何被消费；同样地，消费者只管往消息队列中取数据，而不用管数据的来源。

## 消息队列的作用

- 解耦

- 异步
- 削峰

### 解耦

假设现在有 A，B，C，D 四个系统，A 需要给 B, C, D 系统发送消息，那么在 A 的代码中就需要加上给 B, C, D 系统发送消息的代码，此时如果删除或者增加了一个系统，又需要添加或者删除对应的代码，这不满足设计模式中可扩展性的原则，设计模式中的可扩展性要求在不改动原先代码的条件下扩展系系统的功能。增加消息队列这个中间件之后，A 系统只需要往消息队列中放消息，其他的系统按照相应的规则取消息即可，增加或者删除其他的系统不影响 A 系统。通过一个消息队列，就降低了这些系统间的耦合性。

### 异步

假设现在有 A，B，C，D 四个系统，A 需要给 B, C, D 系统发送消息。在没有消息队列的情况下，需要将消息成功发送给 B, C, D 系统之后才能够响应给客户端。增加了消息队列之后，只需要将消息成功发送给消息队列就可以响应客户端，至于后续的操作由消息队列完成，大大提高了响应速度。对于非核心的业务，比如发送短信，发送邮件等就可以使用消息队列的方式来实现。

### 核心业务和非核心业务

比如一个用户注册的功能，该功能的核心业务就是将用户的信息存入数据库即可，只要存入了数据库就可以给用户进行响应了，至于注册成功之后发送短信或者发送邮箱给用户，则属于非核心的业务。

### 削峰

削峰是 MQ 很重要的一个特性。比如系统 A 在某个时间段内请求暴增，系统处理不过来。如果没有消息队列，系统可能会崩溃。在这种情况下就可以将请求存入到消息队列中，而消费者只需要根据它的能力消费消息即可。

## RabbitMQ 的特点

RabbitMQ 是一款使用 Erlang 语言开发的，实现 AMQP (高级消息队列协议) 的开源消息中间件。该中间件的特点如下：

- 可靠性：支持持久化，传输确认，发布确认等保证了 MQ 的可靠性
- 灵活的消息分发策略：这是 RabbitMQ 的一大特点。在消息进入 MQ 之前由 Exchange(交换机) 来路由消息。分发消息的策略有：简单模式，工作队列模式，发布订阅模式，路由模式，通配符模式。
- 支持集群：多台 RabbitMQ 机器可以组成一个集群，形成一个逻辑的 Broker
- 多种协议：RabbitMQ 支持多种消息队列协议，如 STOMP， MQTT 等。
- 支持多语言客户端： RabbitMQ 几乎支持所有常用的编程语言，包括 Java, .NET, Ruby 等
- 可视化管理界面: RabbitMQ 提供了一个简单易用客户端界面，使得用户可以键控和管理消息 Broker.
- 插件机制：RabbitMQ 提供了许多插件，可以通过插件进行扩展，也可以编写自己的插件

## RabbitMq 的消息模型

![](/home/autmaple/Documents/Notes/Attachment/arch_screen_52.b0519322-16561238609703.png)

| 标志 | 中文名     | 英文名   | 描述                                             |
| ---- | ---------- | -------- | ------------------------------------------------ |
| P    | 生产者     | Producer | 消息的发送者，可以将消息发送到交换机             |
| C    | 消费值     | Consumer | 消息的接受者，从队列中拉取消息进行消费           |
| X    | 交换机     | Exchange | 接收生产者发送的消息，并根据路由发送到指定的队列 |
| Q    | 队列       | Queue    | 存储交换机发送过来的消息                         |
| type | 交换机类型 | type     | direct 表示直接根据路由 (orange/black) 发送消息  |

